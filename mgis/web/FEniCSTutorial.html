<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>FEniCS and MFront for complex non linear solid mechanics simulation</title>
        <meta name="author" content="Thomas Helfer, Jérémy Bleyer" />
            <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <style type="text/css">code{white-space: pre;}</style>
            <style type="text/css">
      a.sourceLine { display: inline-block; line-height: 1.25; }
      a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
      a.sourceLine:empty { height: 1.2em; position: absolute; }
      .sourceCode { overflow: visible; }
      code.sourceCode { white-space: pre; position: relative; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      code.sourceCode { white-space: pre-wrap; }
      a.sourceLine { text-indent: -1em; padding-left: 1em; }
      }
      pre.numberSource a.sourceLine
        { position: relative; }
      pre.numberSource a.sourceLine:empty
        { position: absolute; }
      pre.numberSource a.sourceLine::before
        { content: attr(data-line-number);
          position: absolute; left: -5em; text-align: right; vertical-align: baseline;
          border: none; pointer-events: all;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  }
      @media screen {
      a.sourceLine::before { text-decoration: underline; }
      }
      code span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #7d9029; } /* Attribute */
      code span.bn { color: #40a070; } /* BaseN */
      code span.bu { } /* BuiltIn */
      code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4070a0; } /* Char */
      code span.cn { color: #880000; } /* Constant */
      code span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code span.dt { color: #902000; } /* DataType */
      code span.dv { color: #40a070; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #40a070; } /* Float */
      code span.fu { color: #06287e; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code span.op { color: #666666; } /* Operator */
      code span.ot { color: #007020; } /* Other */
      code span.pp { color: #bc7a00; } /* Preprocessor */
      code span.sc { color: #4070a0; } /* SpecialChar */
      code span.ss { color: #bb6688; } /* SpecialString */
      code span.st { color: #4070a0; } /* String */
      code span.va { color: #19177c; } /* Variable */
      code span.vs { color: #4070a0; } /* VerbatimString */
      code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>
            <link rel="stylesheet" href="css/normalize.css"/>
    <link rel="stylesheet" href="css/main.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
          </head>
  <body>
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
        <header>
    </header>
    <br></br>
        <div id="header">
      <h1 class="title"><code>FEniCS</code> and <code>MFront</code> for complex non linear solid mechanics simulation</h1>
                  <h2 class="author">Thomas Helfer, Jérémy Bleyer</h2>
                  <h3 class="date">15/01/2019</h3>
          </div>
            <p>This document is meant to show how <code>FEniCS</code> and <code>MFront</code> can be combined to build almost arbitrary complex non linear solid mechanics simulation. As <code>MFront</code> currently allows the implementation of small and finite strain mechanical behaviours, the current scope of this coupling is limited to standard first order theories<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. Generalised behaviours, usable in monolithic multiphysics simulations and/or higher order mechanical theories, will be available in the next version<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p><code>FEniCS</code> will handle:</p>
<ul>
<li>The computation of the gradients (the strain in the infinitesimal strain assumption, the deformation gradient in finite strain).</li>
<li>The assembly of the internal and external forces.</li>
<li>The assembly of the stiffness matrix</li>
</ul>
<p>The <code>MFront</code> behaviour will handle, at each integration point:</p>
<ul>
<li>The computation of the thermodynamic forces (the Cauchy stress here).</li>
<li>The update of the internal state variables.</li>
<li>The computation of the consistent tangent operator.</li>
</ul>
<p>The interface with <code>FEniCS</code> will be handled by the <code>MFrontGenericInterfaceSupport</code> project<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. This project aims at proving tools (functions, classes, bindings, etc…) to handle behaviours written using <code>MFront</code> generic interface. Written in <code>C++</code>, it provides bindings for various languages: <code>C</code>, <code>python</code>, <code>fortran</code>. This library also provides the so-called <code>FEniCS</code> bindings described below.</p>
<p>This document considers two approaches:</p>
<ul>
<li>The first one will rely on the <code>python</code> bindings. This approach requires the user to write its own version of the Newton solver.</li>
<li>The second one, strongly inspired by the <code>fenics-solid-mechanics</code> project written by Kristian B. Ølgaard and Garth N. Wells<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>, will allow the usage of the standard Newton-Raphson procedure delivered by <code>dolfin</code>. This approach is the basis of the <code>FEniCS</code> bindings.</li>
</ul>
<p>Each approach has its strengths and weaknesses:</p>
<ul>
<li>The first approach is very flexible can be easily used to describe a large number of situations. It is however probably be less efficient numerically. In particular, the consistent tangent operator is stored at each integration pion, which can be a memory bottleneck for large simulations.</li>
<li>The second approach is currently limited to <span class="math inline">\(3D\)</span> simulations written in <code>C++</code> and small strain behaviours<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. The computation of the gradients and the construction of inner forces and the consistent tangent operator are handled at element level: this explain why only a limited range of behaviours are currently supported. This approach also requires to go deep in the very gory details of <code>FEniCS</code> internals which are far from trivials and, to the authors opinion, currently insufficiently described for new comers.</li>
</ul>
<h1 id="coupling-at-the-python-level">Coupling at the <code>python</code> level</h1>
<h2 id="rapid-description-of-useful-classes-and-functions-introduced-by-the-mfrontgenericinterface-project">Rapid description of useful classes and functions introduced by the <code>MFrontGenericInterface</code> project</h2>
<p>In this paper, a limited number of classes and functions of the <code>MFrontGenericInterface</code> project will be considered:</p>
<ul>
<li>the <code>Behaviour</code> class handles all the information about a specific <code>MFront</code> behaviour. It is created by the <code>load</code> function which takes the path to a library, the name of a behaviour and a modelling hypothesis.</li>
<li>the <code>MaterialDataManager</code> class handles a bunch of integration points. It is instantiated using an instance of the <code>Behaviour</code> class and the number of integration points<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. The <code>MaterialDataManager</code> contains various interesting members:
<ul>
<li><code>s0</code>: data structure of the <code>MaterialStateManager</code> type which stands for the material state at the beginning of the time step.</li>
<li><code>s1</code>: data structure of the <code>MaterialStateManager</code> type which stands for the material state at the end of the time step.</li>
<li><code>K</code>: a <code>numpy</code> array containing the consistent tangent operator at each integration points.</li>
</ul></li>
<li>the <code>MaterialStateManager</code> class describe the state of a material. The following members will be useful in the following:
<ul>
<li><code>gradients</code>: a numpy array containing the value of the gradients at each integration points. The number of components of the gradients at each integration points is given by the <code>gradients_stride</code> member.</li>
<li><code>thermodynamic_forces</code>:a numpy array containing the value of the thermodynamic forces at each integration points. The number of components of the thermodynamic forces at each integration points is given by the <code>thermodynamic_forces_stride</code> member.</li>
<li><code>internal_state_variables</code>: a numpy array containing the value of the internal state variables at each integration points. The number of internal state variables at each integration points is given by the <code>internal_state_variables_stride</code> member.</li>
</ul></li>
<li>the <code>setMaterialProperty</code> and <code>setExternalStateVariable</code> functions can be used to set the value a material property or a state variable respectively.</li>
<li>the <code>update</code> function updates an instance of the <code>MaterialStateManager</code> by copying the state <code>s1</code> at the end of the time step in the state <code>s0</code> at the beginning of the time step.</li>
<li>the <code>revert</code> function reverts an instance of the <code>MaterialStateManager</code> by copying the state <code>s0</code> at the beginning of the time step in the state <code>s1</code> at the end of the time step.</li>
<li>the <code>integrate</code> function triggers the behaviour integration at each integration points. Various overloads of this function exist. We will use a version taking as argument a <code>MaterialStateManager</code>, the time increment and a range of integration points.</li>
</ul>
<p>Those classes and functions are available in the <code>mgis.behaviour</code> <code>python</code> module.</p>
<h3 id="initialisation-of-a-single-material">Initialisation of a single material</h3>
<p>Assuming that number of integration points is known and stored in the <code>ng</code> variable, a possible initialisation of a behaviour and a material data manager can be:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># modelling hypothesis</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">h <span class="op">=</span> mgis_bv.Hypothesis.PlaneStrain</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># loading the behaviour        </span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">b <span class="op">=</span> mgis_bv.load(<span class="st">&#39;src/libBehaviour.so&#39;</span>,<span class="st">&#39;IsotropicLinearHardeningPlasticity&#39;</span>,h)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co"># material data manager</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">m <span class="op">=</span> mgis_bv.MaterialDataManager(b,ngauss)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="cf">for</span> s <span class="kw">in</span> [m.s0, m.s1]:</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    mgis_bv.setMaterialProperty(s, <span class="st">&quot;YoungModulus&quot;</span>, <span class="fl">150e9</span>)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    mgis_bv.setMaterialProperty(s, <span class="st">&quot;PoissonRatio&quot;</span>, <span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    mgis_bv.setMaterialProperty(s, <span class="st">&quot;HardeningSlope&quot;</span>, <span class="fl">150e6</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    mgis_bv.setMaterialProperty(s, <span class="st">&quot;YieldStrength&quot;</span>, <span class="fl">200e6</span>)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    mgis_bv.setExternalStateVariable(s, <span class="st">&quot;Temperature&quot;</span>, <span class="fl">293.15</span>)</a></code></pre></div>
<h3 id="an-example-of-a-newton-loop-for-a-single-material">An example of a Newton loop for a single material</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="cf">for</span> (i, t) <span class="kw">in</span> <span class="bu">enumerate</span>(load_steps):</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    loading.t <span class="op">=</span> t</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    A, Res <span class="op">=</span> assemble_system(a_Newton, res, bc)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    nRes0 <span class="op">=</span> Res.norm(<span class="st">&quot;l2&quot;</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    nRes <span class="op">=</span> nRes0</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    u1.assign(u)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="bu">print</span>(<span class="st">&quot;Increment:&quot;</span>, <span class="bu">str</span>(i<span class="op">+</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    niter <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="cf">while</span> nRes<span class="op">/</span>nRes0 <span class="op">&gt;</span> tol <span class="kw">and</span> niter <span class="op">&lt;</span> Nitermax:</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">        solve(A, du.vector(), Res, <span class="st">&quot;mumps&quot;</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">        <span class="co"># current estimate of the displacement at the end of the time step </span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">        u1.assign(u1<span class="op">+</span>du)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">        <span class="co"># project the strain on the Quadrature space with `MFront` conventions</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">        local_project(eps_MFront(u1), Weps, deps)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">        <span class="co"># assigning the values in the material data manager</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">        m.s1.gradients[:, :] <span class="op">=</span> deps.vector().get_local().reshape((m.n, m.gradients_stride))</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">        <span class="co"># behaviour integration</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">        it <span class="op">=</span> mgis_bv.IntegrationType.IntegrationWithConsitentTangentOperator</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">        mgis_bv.integrate(m, it, <span class="dv">0</span>, <span class="dv">0</span>, m.n)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">        <span class="co"># getting the thermodynamic forces and the consistent tangent operator for FEniCS</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">        sig.vector().set_local(m.s1.thermodynamic_forces.flatten())</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">        sig.vector().<span class="bu">apply</span>(<span class="st">&quot;insert&quot;</span>)</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">        Ct.vector().set_local(m.K.flatten())</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">        Ct.vector().<span class="bu">apply</span>(<span class="st">&quot;insert&quot;</span>)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">        <span class="co"># solve Newton system</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">        A, Res <span class="op">=</span> assemble_system(a_Newton, res, bc)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">        nRes <span class="op">=</span> Res.norm(<span class="st">&quot;l2&quot;</span>)</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">        <span class="bu">print</span>(<span class="st">&quot;    Residual:&quot;</span>, nRes)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">        niter <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    <span class="co"># update for new increment</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">    u.assign(u1)</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">    mgis_bv.update(m)</a></code></pre></div>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Cohesive zone models are not considered here, mostly because the authors don’t know if it is even possible to introduce them in <code>FEniCS</code>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Indeed, being able to test this new feature is one of the main reason why an interface to <code>FEniCS</code> has been considered.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><a href="https://github.com/thelfer/MFrontGenericInterfaceSupport" class="uri">https://github.com/thelfer/MFrontGenericInterfaceSupport</a><a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p><a href="https://bitbucket.org/fenics-apps/fenics-solid-mechanics" class="uri">https://bitbucket.org/fenics-apps/fenics-solid-mechanics</a><a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p><span class="math inline">\(2D\)</span> simulations is theoretically supported, but the authors acknowledges that this is not currently functional.<a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p>Note that an instance of <code>MaterialDataManager</code> keeps a reference to the behaviour which has been used for its initialization: the user must ensure that this behaviour outlives the instance of the <code>MaterialDataManager</code>, otherwise memory corruption may occur.<a href="#fnref6" class="footnote-back">↩</a></p></li>
</ol>
</section>
      </body>
</html>
